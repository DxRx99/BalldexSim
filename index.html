<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BallDex Simulator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        /* --- THEME VARIABLES --- */
        :root {
            /* Dark Mode (Default) */
            --bg-main: #36393e;
            --bg-card: #2f3136;
            --bg-input: #202225;
            --bg-hover: #40444b;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #202225;
            --scroll-track: #2f3136;
            --scroll-thumb: #202225;
        }

        [data-theme="light"] {
            /* Light Mode */
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #e5e7eb;
            --bg-hover: #d1d5db;
            --text-main: #111827;
            --text-muted: #4b5563;
            --border-color: #d1d5db;
            --scroll-track: #e5e7eb;
            --scroll-thumb: #9ca3af;
        }

        /* --- BASE STYLES --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dynamic Classes for JS toggling */
        .theme-card { background-color: var(--bg-card); border-color: var(--border-color); }
        .theme-input { background-color: var(--bg-input); color: var(--text-main); border-color: var(--bg-hover); }
        .theme-hover:hover { background-color: var(--bg-hover); }
        .text-muted { color: var(--text-muted); }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Image Logic */
        .uncaught-img { 
            filter: grayscale(100%) brightness(0) opacity(0.3); 
        }
        /* Invert silhouette for Dark Mode so it's visible */
        :not([data-theme="light"]) .uncaught-img {
            filter: grayscale(100%) brightness(0) invert(1) opacity(0.5);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        /* Modal Backdrop */
        #modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }

        /* Fallback Ball Style */
        .fallback-ball {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            border: 4px solid rgba(0,0,0,0.5);
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.5);
            font-size: 1rem;
            padding: 10px;
            line-height: 1.1;
            background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col transition-colors duration-300">

    <!-- Navbar -->
    <nav id="navbar" class="hidden theme-card border-b p-4 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.switchView('spawn')">
                <div class="bg-indigo-600 p-2 rounded-full shadow-lg">
                    <i class="fas fa-globe-americas text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide leading-tight">BallDex<span class="text-indigo-500">Sim</span></h1>
                    <div class="text-[10px] text-muted font-mono">Trainer: <span id="nav-username" class="text-indigo-400">Guest</span></div>
                </div>
            </div>
            
            <div class="flex gap-2 sm:gap-3">
                <button id="nav-spawn" onclick="window.switchView('spawn')" class="px-3 py-2 rounded-md transition-all font-medium">Spawn</button>
                <button id="nav-dex" onclick="window.switchView('dex')" class="px-3 py-2 rounded-md transition-all font-medium flex items-center gap-2"><i class="fas fa-book"></i> <span class="hidden sm:inline">Dex</span></button>
                <button id="nav-index" onclick="window.switchView('index')" class="px-3 py-2 rounded-md transition-all font-medium flex items-center gap-2"><i class="fas fa-list"></i> <span class="hidden sm:inline">Index</span></button>
                <button id="nav-settings" onclick="window.switchView('settings')" class="px-3 py-2 rounded-md transition-all font-medium"><i class="fas fa-cog"></i></button>
                <button onclick="window.logout()" class="px-3 py-2 rounded-md transition-all text-red-400 hover:bg-red-500/10 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 w-full">

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="w-full max-w-md fade-in">
            <div class="theme-card p-8 rounded-xl shadow-2xl border text-center transition-colors duration-300">
                <div class="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/30">
                    <i class="fas fa-sign-in-alt text-3xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2">Login</h2>
                <p class="text-muted mb-8">Welcome back, Trainer.</p>
                
                <form onsubmit="window.handleLogin(event)" class="space-y-4">
                    <div class="relative text-left">
                        <label class="text-xs text-muted font-bold ml-1 uppercase">Username</label>
                        <input id="login-input" type="text" placeholder="Username" required class="theme-input w-full p-3 rounded-lg border focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div class="relative text-left">
                        <label class="text-xs text-muted font-bold ml-1 uppercase">Password</label>
                        <input id="login-password" type="password" placeholder="Password" required class="theme-input w-full p-3 rounded-lg border focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm font-bold hidden"></div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition-transform transform hover:scale-[1.02]">Login</button>
                </form>
                <div class="mt-6 text-sm text-muted">
                    Don't have an account? <button onclick="window.switchView('register')" class="text-indigo-400 hover:underline font-bold">Create One</button>
                </div>
            </div>
        </div>

        <!-- VIEW: REGISTER -->
        <div id="view-register" class="hidden w-full max-w-md fade-in">
            <div class="theme-card p-8 rounded-xl shadow-2xl border text-center transition-colors duration-300">
                <div class="bg-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-500/30">
                    <i class="fas fa-user-plus text-3xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2">Create Account</h2>
                <p class="text-muted mb-8">Start your collection journey.</p>
                
                <form onsubmit="window.handleRegister(event)" class="space-y-4">
                    <div class="relative text-left">
                        <label class="text-xs text-muted font-bold ml-1 uppercase">Choose Username</label>
                        <input id="reg-username" type="text" placeholder="Username" required class="theme-input w-full p-3 rounded-lg border focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div class="relative text-left">
                        <label class="text-xs text-muted font-bold ml-1 uppercase">Password</label>
                        <input id="reg-password" type="password" placeholder="Password" required class="theme-input w-full p-3 rounded-lg border focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div class="relative text-left">
                        <label class="text-xs text-muted font-bold ml-1 uppercase">Confirm Password</label>
                        <input id="reg-confirm" type="password" placeholder="Confirm Password" required class="theme-input w-full p-3 rounded-lg border focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div id="reg-error" class="text-red-500 text-sm font-bold hidden"></div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition-transform transform hover:scale-[1.02]">Sign Up</button>
                </form>
                <div class="mt-6 text-sm text-muted">
                    Already have an account? <button onclick="window.switchView('login')" class="text-indigo-400 hover:underline font-bold">Login Here</button>
                </div>
            </div>
        </div>

        <!-- VIEW: SPAWN -->
        <div id="view-spawn" class="hidden w-full max-w-md fade-in">
            <div class="theme-card p-6 rounded-xl shadow-2xl border relative overflow-hidden transition-colors duration-300">
                <!-- Rarity Glow -->
                <div id="rarity-glow" class="hidden absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 via-yellow-500 to-red-500 animate-pulse"></div>

                <div class="mb-4 flex justify-between items-center text-sm theme-input p-2 rounded-lg">
                    <span>Streak: <span id="streak-display" class="text-indigo-400 font-bold">0</span></span>
                    <span>Caught: <span id="caught-count-spawn" class="text-green-500">0</span> / <span id="total-count-spawn">0</span></span>
                </div>

                <!-- Ball Image Area -->
                <div id="spawn-image-container" class="relative aspect-[4/3] w-full theme-input bg-gray-500/10 rounded-lg mb-6 flex items-center justify-center overflow-hidden border border-gray-700/20">
                    <!-- Image -->
                    <img id="spawn-image" src="" class="max-w-[80%] max-h-[80%] object-contain drop-shadow-2xl hidden z-10 transition-transform duration-300 hover:scale-110" referrerpolicy="no-referrer">
                    <div id="loader" class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                    
                    <!-- Fallback Element (Generated Ball) -->
                    <div id="spawn-fallback" class="hidden w-[60%] h-[60%]"></div>
                </div>

                <div id="game-message" class="mb-4 text-center font-bold h-6 text-indigo-400 transition-colors"></div>

                <form id="guess-form" class="relative" onsubmit="window.handleGuess(event)">
                    <input id="guess-input" type="text" placeholder="Guess the country..." autocomplete="off"
                        class="theme-input w-full p-4 pl-5 pr-14 rounded-lg border focus:outline-none focus:border-indigo-500 font-medium transition-colors">
                    <button type="submit" class="absolute right-2 top-2 bottom-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white w-10 flex items-center justify-center shadow-md">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </form>

                <div class="mt-4 text-center">
                    <button onclick="window.skipBall()" class="text-xs text-muted hover:underline">I don't know, skip this ball</button>
                </div>
            </div>
        </div>

        <!-- VIEW: DEX -->
        <div id="view-dex" class="hidden w-full max-w-6xl fade-in pb-10">
            <div class="theme-card rounded-xl p-6 mb-6 flex flex-col sm:flex-row items-center justify-between border shadow-lg transition-colors duration-300">
                <div class="mb-4 sm:mb-0 text-center sm:text-left">
                    <h2 class="text-2xl font-bold flex items-center gap-2 justify-center sm:justify-start">
                        <i class="fas fa-book-open text-indigo-500"></i> BallDex
                    </h2>
                    <p class="text-muted text-sm mt-1">Gotta catch 'em all!</p>
                </div>
                <div class="text-center sm:text-right theme-input p-4 rounded-lg min-w-[200px]">
                    <div id="completion-percent" class="text-4xl font-bold text-indigo-400">0%</div>
                    <div class="w-full bg-gray-700 h-1.5 rounded-full mt-2 overflow-hidden">
                        <div id="completion-bar" class="bg-indigo-500 h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1 flex gap-2 overflow-x-auto pb-2 items-center" id="rarity-legend"></div>
                <div class="flex gap-2 w-full md:w-auto">
                    <select onchange="window.handleSort(this.value)" class="theme-input p-3 rounded-lg border focus:outline-none focus:border-indigo-500 font-medium cursor-pointer">
                        <option value="rarity_desc">Rarity (High)</option>
                        <option value="rarity_asc">Rarity (Low)</option>
                        <option value="name_asc">A-Z</option>
                        <option value="name_desc">Z-A</option>
                        <option value="caught_desc">Caught</option>
                        <option value="caught_asc">Missing</option>
                    </select>
                    <input type="text" id="dex-search" placeholder="Search..." onkeyup="window.filterDex()" 
                        class="theme-input flex-grow p-3 rounded-lg border focus:outline-none focus:border-indigo-500 font-medium">
                </div>
            </div>

            <div id="dex-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
        </div>

        <!-- VIEW: INDEX -->
        <div id="view-index" class="hidden w-full max-w-6xl fade-in pb-10">
            <div class="theme-card rounded-xl p-6 mb-6 border shadow-lg transition-colors duration-300">
                <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-list-alt text-indigo-500"></i> Index</h2>
                <p class="text-muted text-sm mt-1">Reference Guide.</p>
            </div>
            <div class="mb-6">
                <input type="text" id="index-search" placeholder="Search index..." onkeyup="window.filterIndex()" 
                    class="theme-input w-full p-3 rounded-lg border focus:outline-none focus:border-indigo-500 font-medium">
            </div>
            <div id="index-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="hidden w-full max-w-2xl fade-in pb-10">
            <div class="theme-card rounded-xl p-8 border shadow-lg transition-colors duration-300">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-cog"></i> Settings</h2>

                <!-- Theme Toggle -->
                <div class="flex items-center justify-between border-b border-gray-700/50 pb-4 mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">App Theme</h3>
                        <p class="text-sm text-muted">Toggle between Dark and Light mode.</p>
                    </div>
                    <button onclick="window.toggleTheme()" id="theme-btn" class="px-4 py-2 rounded bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition">
                        Switch Theme
                    </button>
                </div>

                <!-- Data -->
                <h3 class="text-lg font-semibold mt-8 mb-4">Data</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="theme-input p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Export Data</h4>
                        <button onclick="window.exportData()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded text-sm transition">Copy to Clipboard</button>
                    </div>
                    <div class="theme-input p-4 rounded-lg border">
                        <h4 class="font-bold text-green-400 mb-2">Save Data</h4>
                        <button onclick="window.manualSave()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm transition">Force Save Now</button>
                    </div>
                    <div class="theme-input p-4 rounded-lg border col-span-1 md:col-span-2">
                        <h4 class="font-bold text-red-400 mb-2">Danger Zone</h4>
                        <button onclick="window.resetData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm transition">Delete Everything</button>
                    </div>
                </div>
                <div class="mt-8 text-center text-xs text-muted font-mono">BallDex Simulator v2.2 - Ultimate Edition</div>
            </div>
        </div>

        <!-- MODAL: BALL DETAILS -->
        <div id="modal-backdrop" class="fixed inset-0 hidden z-[100] flex items-center justify-center p-4">
            <div class="theme-card max-w-sm w-full rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 relative flex flex-col">
                
                <div class="aspect-[4/3] bg-gray-700/20 flex items-center justify-center p-6 relative overflow-hidden" id="modal-image-container">
                    <!-- Close button -->
                    <button onclick="window.closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white bg-black/40 hover:bg-black/70 rounded-full w-8 h-8 flex items-center justify-center transition z-50 cursor-pointer">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-500 via-transparent to-transparent"></div>
                    <img id="modal-image" src="" class="max-w-full max-h-full drop-shadow-2xl z-10 object-contain transition-transform duration-500 hover:scale-110" referrerpolicy="no-referrer">
                    <div id="modal-fallback" class="hidden w-[60%] h-[60%] z-20"></div>
                </div>
                
                <div class="p-6 text-center">
                    <div class="mb-4">
                        <span id="modal-rarity" class="text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider border"></span>
                    </div>
                    <h2 id="modal-name" class="text-3xl font-extrabold mb-1 tracking-tight"></h2>
                    <p id="modal-id" class="text-xs font-mono text-muted mb-6 uppercase tracking-widest opacity-60"></p>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-indigo-500/10 p-2 rounded-lg border border-indigo-500/20">
                            <span class="block text-xs text-indigo-400 font-bold mb-1">ALIASES</span>
                            <span id="modal-aliases" class="text-muted block truncate">None</span>
                        </div>
                        <div id="modal-status-container" class="bg-green-500/10 p-2 rounded-lg border border-green-500/20">
                            <span id="modal-status-label" class="block text-xs text-green-400 font-bold mb-1">STATUS</span>
                            <span id="modal-status-text" class="text-green-300 font-bold">Caught</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOAST -->
        <div id="toast">Saved Successfully!</div>

    </main>

    <script>
    (function() {
        
        // --- PROXY HELPER ---
        function proxify(url) {
            if(!url) return '';
            if(url.includes('flagcdn')) return url; 
            if(url.includes('upload.wikimedia.org')) return url; // Trust direct uploads if we use them
            // Robust Wikimedia Proxy using Special:Redirect API
            return `https://wsrv.nl/?url=${encodeURIComponent(url)}&output=png`;
        }

        // --- DATA ---
        // CORRECTED Links for Broken Images using robust Special:Redirect or direct uploads
        const SPECIAL_BALLS_RAW = [
            // Tier 1
            { id: 'reichtangle', name: 'Reichtangle', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_German_Empire.svg&width=640', aliases: ['second reich'] },
            { id: 'british_empire', name: 'British Empire', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_United_Kingdom.svg&width=640', aliases: ['be'] },
            { id: 'russian_empire', name: 'Russian Empire', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Russia_(1858–1883).svg&width=640', aliases: ['re'] },
            { id: 'soviet_union', name: 'Soviet Union', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Soviet_Union.svg&width=640', aliases: ['ussr', 'cccp'] },
            { id: 'roman_empire', name: 'Roman Empire', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Vexilloid_of_the_Roman_Empire.svg&width=400', aliases: ['rome', 'spqr'] },
            { id: 'kalmar_union', name: 'Kalmar Union', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Kalmar_Union.svg&width=640', aliases: ['kalmar'] },
            { id: 'qin_dynasty', name: 'Qin Dynasty', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Small_Seal_Script_Qin.svg&width=400', aliases: ['qin'] },
            { id: 'vatican_holy_see', name: 'Holy See', rarity: 'T1', code: 'va', aliases: ['vatican'] },
            { id: 'sealand', name: 'Sealand', rarity: 'T1', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Sealand.svg&width=640' },
            
            // Tier 8 / Historical
            { id: 'austria_hungary', name: 'Austria-Hungary', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Austria-Hungary_(1869-1918).svg&width=640', aliases: ['ah'] },
            { id: 'prussia', name: 'Prussia', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Prussia_(1892-1918).svg&width=640' },
            { id: 'qing_dynasty', name: 'Qing Dynasty', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_China_(1889–1912).svg&width=640', aliases: ['qing'] },
            { id: 'ottoman_empire', name: 'Ottoman Empire', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Ottoman_Empire.svg&width=640', aliases: ['ottoman'] },
            { id: 'japanese_empire', name: 'Japanese Empire', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/War_flag_of_the_Imperial_Japanese_Army_(1868–1945).svg&width=640', aliases: ['imperial japan'] },
            { id: 'spanish_empire', name: 'Spanish Empire', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Cross_of_Burgundy.svg&width=640' },
            { id: 'byzantium', name: 'Byzantium', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Palaiologos-Dynasty-Eagle.svg&width=640', aliases: ['byzantine empire'] },
            { id: 'ancient_greece', name: 'Ancient Greece', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Greece_(1822-1978).svg&width=640', aliases: ['greece'] },
            { id: 'hunnic_empire', name: 'Hunnic Empire', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Huns_(supposed).svg&width=640', aliases: ['huns'] },
            { id: 'xiongnu', name: 'Xiongnu', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Xiongnu_Flag.svg&width=640' },
            { id: 'majapahit', name: 'Majapahit Empire', rarity: 'T8', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Majapahit_Empire.svg&width=640' },
            
            // Organizations & Rares
            { id: 'united_nations', name: 'United Nations', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_United_Nations.svg&width=640', aliases: ['un'] },
            { id: 'european_union', name: 'European Union', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Europe.svg&width=640', aliases: ['eu'] },
            { id: 'nato', name: 'NATO', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_NATO.svg&width=640' },
            { id: 'asean', name: 'ASEAN', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_ASEAN.svg&width=640' },
            { id: 'african_union', name: 'African Union', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_African_Union.svg&width=640', aliases: ['au'] },
            { id: 'arab_league', name: 'Arab League', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_League_of_Arab_States.svg&width=640' },

            // More Historical
            { id: 'napoleonic_france', name: 'Napoleonic France', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_France.svg&width=640', aliases: ['first french empire'] },
            { id: 'carthage', name: 'Carthage', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Carthaginian_Standard.svg&width=400' },
            { id: 'ancient_egypt', name: 'Ancient Egypt', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Egypt_(1922–1958).svg&width=640' },
            { id: 'ussr_ssr', name: 'Russian SFSR', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Russian_Soviet_Federative_Socialist_Republic_(1954–1991).svg&width=640' },
            { id: 'sparta', name: 'Sparta', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Vexilloid_of_Sparta.svg&width=400' },
            { id: 'athens', name: 'Athens', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Owl_of_Athena.svg&width=640' },
            { id: 'phoenicia', name: 'Phoenicia', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Phoenician_ship.svg&width=640' },
            { id: 'babylon', name: 'Babylon', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Lion_of_Babylon.svg&width=640' },
            { id: 'persian_empire', name: 'Persian Empire', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Standard_of_Cyrus_the_Great_(Achaemenid_Empire).svg&width=640', aliases: ['achaemenid'] },
            { id: 'mongol_empire', name: 'Mongol Empire', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Mongol_Empire.svg&width=640' },
            { id: 'holy_roman_empire', name: 'Holy Roman Empire', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Banner_of_the_Holy_Roman_Emperor_with_haloes_(1400-1806).svg&width=640', aliases: ['hre'] },
            { id: 'east_germany', name: 'East Germany', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_East_Germany.svg&width=640', aliases: ['gdr'] },
            { id: 'yugoslavia', name: 'Yugoslavia', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Yugoslavia_(1946-1992).svg&width=640' },
            { id: 'confederate_states', name: 'Confederate States', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Confederate_States_of_America_(1861–1863).svg&width=640', aliases: ['csa'] },
            { id: 'texas', name: 'Republic of Texas', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Texas.svg&width=640' },
            { id: 'polish_lithuanian_commonwealth', name: 'Polish-Lithuanian Commonwealth', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_the_Polish–Lithuanian_Commonwealth.svg&width=640', aliases: ['plc'] },
            { id: 'kingdom_of_france', name: 'Kingdom of France', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Pavillon_royal_de_la_France.svg&width=640' },
            { id: 'scotland', name: 'Scotland', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Scotland.svg&width=640' },
            { id: 'wales', name: 'Wales', rarity: 'Rare', image: 'https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Flag_of_Wales_(1959–present).svg&width=640' },
            
            // Special Codes that work fine on FlagCDN
            { id: 'hong_kong', name: 'Hong Kong', rarity: 'Rare', code: 'hk' },
            { id: 'macau', name: 'Macau', rarity: 'Rare', code: 'mo' },
            { id: 'puerto_rico', name: 'Puerto Rico', rarity: 'Rare', code: 'pr' },
            { id: 'antarctica', name: 'Antarctica', rarity: 'Rare', code: 'aq' }
        ];

        const MODERN_COUNTRIES = [
            {n:"Afghanistan", c:"af"}, {n:"Albania", c:"al"}, {n:"Algeria", c:"dz"}, {n:"Andorra", c:"ad"}, {n:"Angola", c:"ao"}, {n:"Argentina", c:"ar"}, {n:"Armenia", c:"am"}, {n:"Australia", c:"au"}, {n:"Austria", c:"at"}, {n:"Azerbaijan", c:"az"}, {n:"Bahamas", c:"bs"}, {n:"Bahrain", c:"bh"}, {n:"Bangladesh", c:"bd"}, {n:"Barbados", c:"bb"}, {n:"Belarus", c:"by"}, {n:"Belgium", c:"be"}, {n:"Belize", c:"bz"}, {n:"Benin", c:"bj"}, {n:"Bhutan", c:"bt"}, {n:"Bolivia", c:"bo"}, {n:"Bosnia", c:"ba"}, {n:"Botswana", c:"bw"}, {n:"Brazil", c:"br"}, {n:"Brunei", c:"bn"}, {n:"Bulgaria", c:"bg"}, {n:"Burkina Faso", c:"bf"}, {n:"Burundi", c:"bi"}, {n:"Cambodia", c:"kh"}, {n:"Cameroon", c:"cm"}, {n:"Canada", c:"ca"}, {n:"Cape Verde", c:"cv"}, {n:"Central African Republic", c:"cf"}, {n:"Chad", c:"td"}, {n:"Chile", c:"cl"}, {n:"China", c:"cn", a:["prc"]}, {n:"Colombia", c:"co"}, {n:"Comoros", c:"km"}, {n:"Congo", c:"cg"}, {n:"DR Congo", c:"cd", a:["drc"]}, {n:"Costa Rica", c:"cr"}, {n:"Croatia", c:"hr"}, {n:"Cuba", c:"cu"}, {n:"Cyprus", c:"cy"}, {n:"Czechia", c:"cz"}, {n:"Denmark", c:"dk"}, {n:"Djibouti", c:"dj"}, {n:"Dominica", c:"dm"}, {n:"Dominican Republic", c:"do"}, {n:"Ecuador", c:"ec"}, {n:"Egypt", c:"eg"}, {n:"El Salvador", c:"sv"}, {n:"Equatorial Guinea", c:"gq"}, {n:"Eritrea", c:"er"}, {n:"Estonia", c:"ee"}, {n:"Eswatini", c:"sz"}, {n:"Ethiopia", c:"et"}, {n:"Fiji", c:"fj"}, {n:"Finland", c:"fi"}, {n:"France", c:"fr"}, {n:"Gabon", c:"ga"}, {n:"Gambia", c:"gm"}, {n:"Georgia", c:"ge"}, {n:"Germany", c:"de"}, {n:"Ghana", c:"gh"}, {n:"Greece", c:"gr"}, {n:"Grenada", c:"gd"}, {n:"Guatemala", c:"gt"}, {n:"Guinea", c:"gn"}, {n:"Guinea-Bissau", c:"gw"}, {n:"Guyana", c:"gy"}, {n:"Haiti", c:"ht"}, {n:"Honduras", c:"hn"}, {n:"Hungary", c:"hu"}, {n:"Iceland", c:"is"}, {n:"India", c:"in"}, {n:"Indonesia", c:"id"}, {n:"Iran", c:"ir"}, {n:"Iraq", c:"iq"}, {n:"Ireland", c:"ie"}, {n:"Israel", c:"il"}, {n:"Italy", c:"it"}, {n:"Ivory Coast", c:"ci"}, {n:"Jamaica", c:"jm"}, {n:"Japan", c:"jp"}, {n:"Jordan", c:"jo"}, {n:"Kazakhstan", c:"kz"}, {n:"Kenya", c:"ke"}, {n:"Kuwait", c:"kw"}, {n:"Kyrgyzstan", c:"kg"}, {n:"Laos", c:"la"}, {n:"Latvia", c:"lv"}, {n:"Lebanon", c:"lb"}, {n:"Lesotho", c:"ls"}, {n:"Liberia", c:"lr"}, {n:"Libya", c:"ly"}, {n:"Liechtenstein", c:"li"}, {n:"Lithuania", c:"lt"}, {n:"Luxembourg", c:"lu"}, {n:"Madagascar", c:"mg"}, {n:"Malawi", c:"mw"}, {n:"Malaysia", c:"my"}, {n:"Maldives", c:"mv"}, {n:"Mali", c:"ml"}, {n:"Malta", c:"mt"}, {n:"Mauritania", c:"mr"}, {n:"Mauritius", c:"mu"}, {n:"Mexico", c:"mx"}, {n:"Micronesia", c:"fm"}, {n:"Moldova", c:"md"}, {n:"Monaco", c:"mc"}, {n:"Mongolia", c:"mn"}, {n:"Montenegro", c:"me"}, {n:"Morocco", c:"ma"}, {n:"Mozambique", c:"mz"}, {n:"Myanmar", c:"mm"}, {n:"Namibia", c:"na"}, {n:"Nauru", c:"nr"}, {n:"Nepal", c:"np"}, {n:"Netherlands", c:"nl"}, {n:"New Zealand", c:"nz"}, {n:"Nicaragua", c:"ni"}, {n:"Niger", c:"ne"}, {n:"Nigeria", c:"ng"}, {n:"North Korea", c:"kp", a:["dprk"]}, {n:"North Macedonia", c:"mk"}, {n:"Norway", c:"no"}, {n:"Oman", c:"om"}, {n:"Pakistan", c:"pk"}, {n:"Palau", c:"pw"}, {n:"Palestine", c:"ps"}, {n:"Panama", c:"pa"}, {n:"Papua New Guinea", c:"pg"}, {n:"Paraguay", c:"py"}, {n:"Peru", c:"pe"}, {n:"Philippines", c:"ph"}, {n:"Poland", c:"pl"}, {n:"Portugal", c:"pt"}, {n:"Qatar", c:"qa"}, {n:"Romania", c:"ro"}, {n:"Russia", c:"ru"}, {n:"Rwanda", c:"rw"}, {n:"Saint Kitts and Nevis", c:"kn"}, {n:"Saint Lucia", c:"lc"}, {n:"Saint Vincent", c:"vc"}, {n:"Samoa", c:"ws"}, {n:"San Marino", c:"sm"}, {n:"Sao Tome", c:"st"}, {n:"Saudi Arabia", c:"sa"}, {n:"Senegal", c:"sn"}, {n:"Serbia", c:"rs"}, {n:"Seychelles", c:"sc"}, {n:"Sierra Leone", c:"sl"}, {n:"Singapore", c:"sg"}, {n:"Slovakia", c:"sk"}, {n:"Slovenia", c:"si"}, {n:"Solomon Islands", c:"sb"}, {n:"Somalia", c:"so"}, {n:"South Africa", c:"za"}, {n:"South Korea", c:"kr"}, {n:"South Sudan", c:"ss"}, {n:"Spain", c:"es"}, {n:"Sri Lanka", c:"lk"}, {n:"Sudan", c:"sd"}, {n:"Suriname", c:"sr"}, {n:"Sweden", c:"se"}, {n:"Switzerland", c:"ch"}, {n:"Syria", c:"sy"}, {n:"Taiwan", c:"tw"}, {n:"Tajikistan", c:"tj"}, {n:"Tanzania", c:"tz"}, {n:"Thailand", c:"th"}, {n:"Timor-Leste", c:"tl"}, {n:"Togo", c:"tg"}, {n:"Tonga", c:"to"}, {n:"Trinidad and Tobago", c:"tt"}, {n:"Tunisia", c:"tn"}, {n:"Turkey", c:"tr"}, {n:"Turkmenistan", c:"tm"}, {n:"Tuvalu", c:"tv"}, {n:"Uganda", c:"ug"}, {n:"Ukraine", c:"ua"}, {n:"UAE", c:"ae"}, {n:"UK", c:"gb"}, {n:"USA", c:"us"}, {n:"Uruguay", c:"uy"}, {n:"Uzbekistan", c:"uz"}, {n:"Vanuatu", c:"vu"}, {n:"Vatican City", c:"va"}, {n:"Venezuela", c:"ve"}, {n:"Vietnam", c:"vn"}, {n:"Yemen", c:"ye"}, {n:"Zambia", c:"zm"}, {n:"Zimbabwe", c:"zw"}, {n:"Kosovo", c:"xk"}
        ];

        // Combine Data
        const COUNTRIES_DATA = [
            ...SPECIAL_BALLS_RAW, 
            ...MODERN_COUNTRIES.map(c => ({ id: c.c, name: c.n, rarity: 'Common', code: c.c, aliases: c.a || [] }))
        ];

        // Constants
        const RARITY_COLORS = {
            'T1': 'text-red-500 border-red-500/50',
            'T8': 'text-orange-500 border-orange-500/50',
            'Rare': 'text-purple-500 border-purple-500/50',
            'Common': 'text-blue-400 border-blue-500/50'
        };
        const RARITY_ORDER = ['T1', 'T8', 'Rare', 'Common'];

        // State
        var appState = {
            username: null,
            currentBall: null,
            caughtBalls: [],
            streak: 0,
            sortBy: 'rarity_desc',
            view: 'login',
            theme: 'dark'
        };

        // --- INIT ---
        function init() {
            const lastUser = localStorage.getItem('balldex_last_user');
            if(lastUser) {
                try {
                    const data = JSON.parse(localStorage.getItem(`balldex_${lastUser}_data`));
                    if(data) {
                        if(data.theme) applyTheme(data.theme);
                        loginSuccess(lastUser, data);
                        showToast(`Welcome back, ${lastUser}!`);
                    }
                } catch(e) {}
            }
            updateUI();
        }

        // --- AUTH ---
        window.handleLogin = function(e) {
            e.preventDefault();
            const u = document.getElementById('login-input').value.trim();
            const p = document.getElementById('login-password').value.trim();
            const err = document.getElementById('login-error');
            
            if(!u || !p) return;

            if(u === 'admin' && p === 'Admin111222333') {
                let adminData = JSON.parse(localStorage.getItem('balldex_admin_data'));
                if(!adminData) {
                    adminData = { password: p, caught: [], streak: 0, theme: 'dark' };
                    localStorage.setItem('balldex_admin_data', JSON.stringify(adminData));
                }
                loginSuccess('admin', adminData);
                return;
            }

            const key = `balldex_${u}_data`;
            const saved = localStorage.getItem(key);

            if(!saved) {
                err.classList.remove('hidden');
                err.textContent = "User not found. Please create an account.";
                return;
            }

            const data = JSON.parse(saved);
            if(data.password !== p) {
                err.classList.remove('hidden');
                err.textContent = "Incorrect password.";
                return;
            }

            loginSuccess(u, data);
        }

        window.handleRegister = function(e) {
            e.preventDefault();
            const u = document.getElementById('reg-username').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            const c = document.getElementById('reg-confirm').value.trim();
            const err = document.getElementById('reg-error');

            if(p !== c) {
                err.classList.remove('hidden');
                err.textContent = "Passwords do not match.";
                return;
            }

            if(u === 'admin') {
                err.classList.remove('hidden');
                err.textContent = "Username 'admin' is reserved.";
                return;
            }

            const key = `balldex_${u}_data`;
            if(localStorage.getItem(key)) {
                err.classList.remove('hidden');
                err.textContent = "Username already taken.";
                return;
            }

            const newData = {
                password: p,
                caught: [],
                streak: 0,
                theme: 'dark'
            };
            localStorage.setItem(key, JSON.stringify(newData));
            loginSuccess(u, newData);
        }

        function loginSuccess(u, data) {
            appState.username = u;
            appState.caughtBalls = data.caught || [];
            appState.streak = data.streak || 0;
            appState.theme = data.theme || 'dark';
            
            localStorage.setItem('balldex_last_user', u);
            applyTheme(appState.theme);
            
            document.getElementById('nav-username').textContent = u;
            document.getElementById('navbar').classList.remove('hidden');
            
            window.switchView('spawn');
            spawnNewBall();
        }

        window.logout = function() {
            appState.username = null;
            localStorage.removeItem('balldex_last_user'); // Clear auto-login
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('login-password').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-confirm').value = '';
            window.switchView('login');
        }

        function saveUserData() {
            if(!appState.username) return;
            const key = `balldex_${appState.username}_data`;
            const currentData = JSON.parse(localStorage.getItem(key)) || {};
            currentData.password = currentData.password || (appState.username === 'admin' ? 'Admin111222333' : ''); 
            currentData.caught = appState.caughtBalls;
            currentData.streak = appState.streak;
            currentData.theme = appState.theme;
            localStorage.setItem(key, JSON.stringify(currentData));
        }

        // --- THEMES ---
        window.toggleTheme = function() {
            appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
            applyTheme(appState.theme);
            saveUserData();
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const btn = document.getElementById('theme-btn');
            if(btn) btn.textContent = theme === 'dark' ? "Switch to Light Mode" : "Switch to Dark Mode";
        }

        // --- VIEW ---
        window.switchView = function(viewName) {
            appState.view = viewName;
            ['view-login', 'view-register', 'view-spawn', 'view-dex', 'view-index', 'view-settings'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            if(appState.username) {
                const navIds = {spawn: 'nav-spawn', dex: 'nav-dex', index: 'nav-index', settings: 'nav-settings'};
                Object.keys(navIds).forEach(key => {
                    const el = document.getElementById(navIds[key]);
                    if(key === viewName) {
                        el.classList.add('bg-indigo-600', 'text-white');
                        el.classList.remove('text-gray-400');
                    } else {
                        el.classList.remove('bg-indigo-600', 'text-white');
                        el.classList.add('text-gray-400');
                    }
                });
                if(viewName === 'dex') renderDex();
                if(viewName === 'index') renderIndex();
            }
        }

        function updateUI() {
            if(appState.view === 'login' && !appState.username) document.getElementById('view-login').classList.remove('hidden');
            else window.switchView(appState.view);
        }

        // --- FALLBACK GENERATOR ---
        function createFallbackBall(name) {
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 3).toUpperCase();
            return `
                <div class="fallback-ball">
                    <span>${initials}<br><span style="font-size: 0.6em; opacity: 0.8; font-weight: normal;">${name}</span></span>
                </div>
            `;
        }

        // --- SPAWN LOGIC ---
        function getBallImage(ball) {
            if(!ball) return '';
            if (ball.image) {
                return proxify(ball.image);
            }
            if (ball.code) {
                return `https://flagcdn.com/w640/${ball.code}.png`;
            }
            return '';
        }

        // Global Error Handler for Grid Images (DEX)
        window.handleGridImageError = function(img) {
            // If already retried or hidden, do nothing or show fallback text
            if(img.dataset.retried === "true") {
                // Replace broken image with fallback DIV in the Grid
                const parent = img.parentElement;
                if(parent && !parent.querySelector('.fallback-ball')) {
                    img.style.display = 'none';
                    const name = img.closest('.theme-card')?.querySelector('h3')?.title || '???';
                    const fb = document.createElement('div');
                    fb.innerHTML = createFallbackBall(name);
                    fb.className = "w-full h-full flex items-center justify-center";
                    parent.appendChild(fb);
                }
                return;
            }
            
            const originalSrc = img.src; 
            img.dataset.retried = "true";
            img.src = proxify(originalSrc);
        }

        function spawnNewBall() {
            const img = document.getElementById('spawn-image');
            const loader = document.getElementById('loader');
            const fallbackEl = document.getElementById('spawn-fallback');
            const rarityGlow = document.getElementById('rarity-glow');

            // Reset UI
            img.classList.add('hidden');
            img.src = '';
            fallbackEl.classList.add('hidden');
            fallbackEl.innerHTML = '';
            loader.classList.remove('hidden');
            rarityGlow.classList.add('hidden');
            
            document.getElementById('guess-input').value = '';
            document.getElementById('game-message').textContent = 'A wild countryball appeared!';
            document.getElementById('game-message').className = 'mb-4 text-center font-bold h-6 text-indigo-400';

            const randomBall = COUNTRIES_DATA[Math.floor(Math.random() * COUNTRIES_DATA.length)];
            appState.currentBall = randomBall;

            img.dataset.retried = "false"; 

            const tempImg = new Image();
            tempImg.referrerPolicy = "no-referrer"; 
            
            tempImg.onload = function() {
                img.src = this.src;
                img.classList.remove('hidden');
                loader.classList.add('hidden');
                if(['T1','T8'].includes(randomBall.rarity)) rarityGlow.classList.remove('hidden');
            };
            
            // ERROR HANDLER -> SHOW FALLBACK BALL
            tempImg.onerror = function() {
                console.log("Load failed for " + randomBall.name + ". Showing fallback.");
                loader.classList.add('hidden');
                
                // Show Fallback
                fallbackEl.innerHTML = createFallbackBall(randomBall.name);
                fallbackEl.classList.remove('hidden');
                
                if(['T1','T8'].includes(randomBall.rarity)) rarityGlow.classList.remove('hidden');
            };
            
            // Start Load
            tempImg.src = getBallImage(randomBall);

            setTimeout(() => {
                const inp = document.getElementById('guess-input');
                if(inp) inp.focus();
            }, 100);
        }

        window.retryImage = function() {
           // Retry is now handled by auto-fallback, but we keep this for manual triggers if needed
           spawnNewBall();
        }

        window.handleGuess = function(e) {
            e.preventDefault();
            if(!appState.currentBall) return;
            const guess = document.getElementById('guess-input').value.toLowerCase().trim();
            const target = appState.currentBall;
            const validNames = [target.name.toLowerCase(), ...(target.aliases || []).map(a => a.toLowerCase())];

            if(validNames.includes(guess)) {
                const isNew = !appState.caughtBalls.includes(target.id);
                if(isNew) appState.caughtBalls.push(target.id);
                appState.streak++;
                
                const msgEl = document.getElementById('game-message');
                msgEl.textContent = `Caught ${target.name}! ${isNew ? '(New!)' : ''}`;
                msgEl.className = 'mb-4 text-center font-bold h-6 text-green-500';
                
                saveUserData();
                updateStats();
                setTimeout(spawnNewBall, 1500);
            } else {
                const msgEl = document.getElementById('game-message');
                msgEl.textContent = "Wrong name!";
                msgEl.className = 'mb-4 text-center font-bold h-6 text-red-500';
                appState.streak = 0;
                saveUserData();
                updateStats();
            }
            document.getElementById('guess-input').value = '';
        }

        window.skipBall = function() {
            if(!appState.currentBall) return;
            const name = appState.currentBall.name;
            const msgEl = document.getElementById('game-message');
            msgEl.textContent = `You fled from ${name}.`;
            msgEl.className = 'mb-4 text-center font-bold h-6 text-red-400';
            appState.streak = 0;
            saveUserData();
            updateStats();
            setTimeout(spawnNewBall, 1500);
        }

        function updateStats() {
            document.getElementById('streak-display').textContent = appState.streak;
            document.getElementById('caught-count-spawn').textContent = appState.caughtBalls.length;
            document.getElementById('total-count-spawn').textContent = COUNTRIES_DATA.length;
            const pct = Math.round((appState.caughtBalls.length / COUNTRIES_DATA.length) * 100);
            document.getElementById('completion-percent').textContent = pct + '%';
            document.getElementById('completion-bar').style.width = pct + '%';
        }

        function renderGrid(containerId, isDex) {
            const container = document.getElementById(containerId);
            const searchVal = document.getElementById(isDex ? 'dex-search' : 'index-search').value.toLowerCase();
            let items = COUNTRIES_DATA.filter(b => b.name.toLowerCase().includes(searchVal) || (b.aliases && b.aliases.some(a => a.toLowerCase().includes(searchVal))));

            if(isDex) {
                const caught = appState.caughtBalls;
                const rarityVal = {'T1':0, 'T8':1, 'Rare':2, 'Common':3};
                items.sort((a,b) => {
                    const ac = caught.includes(a.id);
                    const bc = caught.includes(b.id);
                    switch(appState.sortBy) {
                        case 'rarity_desc': return rarityVal[a.rarity] - rarityVal[b.rarity];
                        case 'rarity_asc': return rarityVal[b.rarity] - rarityVal[a.rarity];
                        case 'name_asc': return a.name.localeCompare(b.name);
                        case 'name_desc': return b.name.localeCompare(a.name);
                        case 'caught_desc': return (ac===bc)?0:(ac?-1:1);
                        case 'caught_asc': return (ac===bc)?0:(ac?1:-1);
                    }
                });
            } else {
                items.sort((a,b) => a.name.localeCompare(b.name));
            }

            let html = '';
            items.forEach(ball => {
                const caught = appState.caughtBalls.includes(ball.id);
                const dimClass = (!caught && isDex) ? 'opacity-60' : '';
                const imgClass = (!caught && isDex) ? 'uncaught-img' : '';
                const rareColor = RARITY_COLORS[ball.rarity];
                const imgSrc = getBallImage(ball);
                const isClickable = caught || !isDex;
                const clickAction = isClickable ? `onclick="window.showModal('${ball.id}')"` : '';
                const cursorClass = isClickable ? 'cursor-pointer' : 'cursor-default';

                html += `
                <div class="theme-card rounded-lg overflow-hidden border transition-transform hover:scale-105 hover:shadow-xl group ${dimClass} ${cursorClass}" ${clickAction}>
                    <div class="aspect-[4/3] p-2 flex items-center justify-center relative bg-gray-700/10">
                        <img src="${imgSrc}" class="max-w-full max-h-full drop-shadow-md ${imgClass}" loading="lazy" referrerpolicy="no-referrer" onerror="window.handleGridImageError(this)">
                        ${caught ? '<i class="fas fa-check-circle text-green-500 absolute top-1 right-1 text-lg drop-shadow-md"></i>' : ''}
                    </div>
                    <div class="p-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] uppercase font-bold px-1.5 py-0.5 rounded border ${rareColor}">${ball.rarity}</span>
                        </div>
                        <h3 class="font-bold text-xs truncate" title="${ball.name}">${(isDex && !caught) ? '???' : ball.name}</h3>
                    </div>
                </div>`;
            });

            if(items.length === 0) html = '<div class="col-span-full text-center text-muted py-8">No countryballs found.</div>';
            container.innerHTML = html;

            if(isDex) {
                const legend = document.getElementById('rarity-legend');
                legend.innerHTML = RARITY_ORDER.map(r => `<span class="px-2 py-1 rounded border text-xs font-bold whitespace-nowrap ${RARITY_COLORS[r]}">${r}</span>`).join('');
            }
        }

        window.renderDex = () => renderGrid('dex-grid', true);
        window.renderIndex = () => renderGrid('index-grid', false);
        window.filterDex = window.renderDex;
        window.filterIndex = window.renderIndex;
        window.handleSort = (val) => { appState.sortBy = val; renderDex(); };

        window.showModal = function(ballId) {
            const ball = COUNTRIES_DATA.find(b => b.id === ballId);
            if(!ball) return;

            // Reset modal state
            const img = document.getElementById('modal-image');
            const fallback = document.getElementById('modal-fallback');
            img.classList.remove('hidden');
            fallback.classList.add('hidden');
            img.src = ''; // clear previous

            // Try load
            img.onerror = function() {
                img.classList.add('hidden');
                fallback.innerHTML = createFallbackBall(ball.name);
                fallback.classList.remove('hidden');
            };
            img.src = getBallImage(ball);

            document.getElementById('modal-name').textContent = ball.name;
            document.getElementById('modal-id').textContent = `ID: ${ball.id}`;
            document.getElementById('modal-rarity').textContent = ball.rarity;
            document.getElementById('modal-rarity').className = `text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider border ${RARITY_COLORS[ball.rarity]}`;
            
            const aliases = ball.aliases && ball.aliases.length > 0 ? ball.aliases.join(', ') : 'None';
            document.getElementById('modal-aliases').textContent = aliases;

            const isCaught = appState.caughtBalls.includes(ballId);
            const statusText = document.getElementById('modal-status-text');
            const statusContainer = document.getElementById('modal-status-container');
            const statusLabel = document.getElementById('modal-status-label');

            if(isCaught) {
                statusText.textContent = "Caught";
                statusText.className = "text-green-300 font-bold";
                statusLabel.className = "block text-xs text-green-400 font-bold mb-1";
                statusContainer.className = "bg-green-500/10 p-2 rounded-lg border border-green-500/20";
            } else {
                statusText.textContent = "Uncaught";
                statusText.className = "text-red-300 font-bold";
                statusLabel.className = "block text-xs text-red-400 font-bold mb-1";
                statusContainer.className = "bg-red-500/10 p-2 rounded-lg border border-red-500/20";
            }

            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }

        document.getElementById('modal-backdrop').addEventListener('click', function(e) {
            if (e.target === this) window.closeModal();
        });

        window.exportData = function() {
            if(!appState.username) return;
            const data = localStorage.getItem(`balldex_${appState.username}_data`);
            navigator.clipboard.writeText(data).then(() => showToast("Data copied to clipboard!"));
        }
        window.manualSave = function() {
            saveUserData();
            showToast("Data Saved Successfully!");
        }
        window.showToast = function(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        window.resetData = function() {
            if(confirm("Delete all progress? This cannot be undone.")) {
                appState.caughtBalls = [];
                appState.streak = 0;
                saveUserData();
                updateStats();
                spawnNewBall();
                showToast("Progress Reset");
            }
        }

        init();

        document.addEventListener('keydown', (e) => {
            if(appState.view === 'spawn' && e.key.length === 1 && /[a-z]/i.test(e.key) && !e.target.matches('input')) {
                document.getElementById('guess-input').focus();
            }
            if (e.key === "Escape") {
                window.closeModal();
            }
        });

    })();
    </script>
</body>
</html>
